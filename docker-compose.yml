version: "3.9"

services:
  postgres:
    image: postgres:18
    container_name: postgres-chat
    restart: unless-stopped
    network_mode: host
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-appuser}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-appsecret}
      - POSTGRES_DB=${POSTGRES_DB:-appdb}
    volumes:
      - ./data/postgres:/var/lib/postgresql
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB} || exit 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: infra-redis
    restart: unless-stopped
    network_mode: host
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./data/redis:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  minio:
    image: minio/minio:latest
    container_name: infra-minio
    restart: unless-stopped
    network_mode: host
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-minioadmin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-minioadmin123}
    command: server --console-address ":9001" /data
    volumes:
      - ./data/minio:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/minio/health/ready"]
      interval: 30s
      timeout: 10s
      retries: 5

  registry:
    image: registry:2
    container_name: infra-registry
    restart: unless-stopped
    network_mode: host
    environment:
      - REGISTRY_STORAGE_DELETE_ENABLED=true
    volumes:
      - ./data/registry:/var/lib/registry
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:5000/v2/"]
      interval: 30s
      timeout: 10s
      retries: 5

  nginx:
    image: nginx:1.27-alpine
    container_name: infra-nginx
    restart: unless-stopped
    network_mode: host
    depends_on:
      - postgres
      - redis
      - minio
      - registry
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - ./nginx/logs:/var/log/nginx
      - ./nginx/certs:/etc/nginx/certs:ro
      - ./nginx/registry.htpasswd:/etc/nginx/registry.htpasswd:ro

volumes: {}
